var localPPTArr = [
{
	id:1,
	content:["https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490169612CPG8YbVs.jpg",
"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img14901696129fJFVgrs.jpg",
"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490169612dWFkaWU7.jpg",
"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img14901696134XENIO73.jpg",
"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490169613zBf7eelx.jpg",
"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490169613r9Vuf30O.jpg",
"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490169614nBcbJVRs.jpg",
"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490169614unptml24.jpg",
"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490169614IGcC4SQd.jpg",
"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490169615KPREhyEE.jpg",
"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490169615JXWrUwAU.jpg",
"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490169615rqY4u4Ye.jpg",
"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490169615l5a5LhQq.jpg",
"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490169616ygWW9ArU.jpg",
"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490169616cPkKa8Ak.jpg",
"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490169616tIJtb31y.jpg",
"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490169616U4iTnz9C.jpg",
"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img14901696172kF37tay.jpg",
"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490169617mk6VWjVt.jpg",
"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img14901696171slh2wmh.jpg",
"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490169618rgYcjP5F.jpg",
"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490169618U5dYRI9g.jpg",
"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490169618zzEwThGa.jpg",
"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490169618z0BAjUnr.jpg",
"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490169619W9Qvg0q9.jpg",
"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490169619hmKmlctJ.jpg",
"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img14901696196IDSN0F1.jpg",
"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490169619oP6HLtcQ.jpg",
"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490169619Ei5cetVt.jpg",
"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img149016962034rkq7m5.jpg",
"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490169620WCf6WEiX.jpg",
"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490169620vXxzWzE4.jpg",
"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490169620pQj6Ejgn.jpg",
"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490169621apcO99CU.jpg",
"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490169621ysya0g1g.jpg"]
},{
	id:2,
	content:[
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490170011OoN1HhcY.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490170011pPS8jVSu.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490170011V8yf3No5.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490170011PT9mDIMW.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490170012V4g5ek0h.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490170012WkFH9Nm0.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490170012pbdHdK1n.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490170012qJ8i215o.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img14901700129qa3MZsb.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490170013yQeV8PKo.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490170013vEvmiC9O.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490170013YqSrDSjm.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490170013lW1QdGid.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img14901700149RaJbk1b.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490170014ozrl4RMb.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490170014A9LYq3Mu.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490170014RhUIH1Yp.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490170014605t0uXq.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490170015qjtN3DKN.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490170015KKoAkayt.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490170015jV1lo30G.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490170015Y48QFzBN.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img14901700161vJYPNgF.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490170016vuk984gR.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490170016c2XPyOzh.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490170016dgRBZY7m.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img14901700163JZYRhFg.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490170017ZU1HMWQa.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490170017jzH1dYLL.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490170017pcQa6mq1.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490170017D5U7FDSx.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490170017xt5HDr9E.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img14901700183CyS4jLG.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490170018A7NWxxf1.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490170018dkW1CelZ.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490170018RSEzOP3R.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490170018WE5JzfEj.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490170019WjzNiCwO.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490170019qK5WPY5l.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490170019jmi5C95z.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490170019ia3SKDXx.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490170019blcXoSnv.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490170019UpCoV3Uk.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img14901700208rr9PFWv.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490170020I1TmWarh.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img149017002070vri18q.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490170020QjQhWSgC.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490170020DlAFA7fA.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490170021ftvmQ1Nw.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490170021BkP46s3P.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490170021w5tH3q6Z.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img14901700217mT7LZAS.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img14901700213Bi8nE5O.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img149017002154waAtAf.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img14901700224sNJpTZf.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490170022qWxp9xRr.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490170022t0USPVMF.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490170022O38OMaeM.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img14901700227DQS0xtO.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490170022rZgynT0w.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490170023qzlqQig4.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img14901700236m3B4fJu.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490170023nULoLaO8.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490170023vOuqKuqF.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490170023sANSafiM.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490170023duhqme8q.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490170024vL52xnLd.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490170024TOYvzIiy.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490170024jBRqhF0q.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490170024U43o1nTr.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img14901700242bSVKwZ2.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490170024APGhhokp.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img149017002458z5JAKu.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img1490170025y28pgPsx.jpg",
	"https://www.hzchuangxiangzhe.cn/php/upload/2017_03_22/img14901700253uTCFbcD.jpg"]
}
]

function renderPPT(pptArr,index){
	$pptHolder.empty();
	$pptHolder.style.transform = 'translateY(0px)';
	if(!pptArr) return;
	pptArr.forEach(function(e){
		var img = new Image();
		img.src = e;
		img.addClass('ppt-item');
		$pptHolder.appendChild(img);
	})
	pptSize();
	$prevPPT.addClass('disabled');
	$pptCurrentPg.textContent = currentPg = 1;
	$pptAllPg.textContent = allPg = pptArr.length;
}

function positionPPT(){
	var pageH = $pptHolder.querySelector('.ppt-item').style.height.slice(0,-2);
	$pptHolder.style.transform = 'translateY(-'+ (currentPg-1)*pageH +'px)';
}

function resetCanvas(){
	localPathArr = [];
	redoPathArr = [];
	$undo.addClass('disabled');
	$redo.addClass('disabled');
	ctx.clearRect(0,0,c.width,c.height);
}

function nextPage(e){
	var t = e.target;
	if(t.hasClass('disabled')) return;
	$pptCurrentPg.textContent = ++currentPg;
	positionPPT();
	resetCanvas();
	$prevPPT.removeClass('disabled');
	if(currentPg === allPg) $nextPPT.addClass('disabled');
	socket.send(JSON.stringify({type:4,page:currentPg-1}));
}

function prevPage(e){
	var t = e.target;
	if(t.hasClass('disabled')) return;
	$pptCurrentPg.textContent = --currentPg;
	positionPPT();
	resetCanvas();
	$nextPPT.removeClass('disabled');
	if(currentPg === 1) $prevPPT.addClass('disabled');
	socket.send(JSON.stringify({type:4,page:currentPg-1}));
}

function switchPPT(e){
	var t = e.target;
	if(!t.hasClass('nav')) return;
	var index = t.index('.nav');
	if(t.hasClass('nav')) {
		document.querySelector('.active.nav').removeClass('active');
		t.addClass('active');
	}
	renderPPT(localPPTArr[index].content,index);
	socket.send(JSON.stringify({type:5,pptIndex:index}));
	resetCanvas();
}

function pptUpload(){
	var file = $pptInput.files[0];
	if(!file) return;
	var pptItem = document.createElement('div');
	pptItem.addClass('ppt-modal-item');
	pptItem.innerHTML =
					'<div class="ppt-modal-progress"></div>' +
					'<div class="ppt-modal-name fl">'+file.name+'</div>' +
					'<div class="ppt-modal-size fl">上传中..</div>' +
					'<div class="ppt-modal-delete fl">删除</div>';
	var $pptItem = $pptContainer.appendChild(pptItem);
	var $pptProgress = $pptItem.querySelector('.ppt-modal-progress');
	var $pptSize = $pptItem.querySelector('.ppt-modal-size');
	pptMaxNum();
	var fm = new FormData();
	fm.append('ppt',file);
	var xhr = new XMLHttpRequest();
	xhr.open('post',rootURL+'?name=education.sys.ppt.upload',true);
	// xhr.setRequestHeader('Content-type', 'multipart/form-data');
	xhr.upload.onprogress = function(event){
	    var percentage = (event.loaded/event.total)*100;
	    $pptProgress.style.width = percentage + '%';
	};
	xhr.onreadystatechange = function(){
		if(xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
		    var data = JSON.parse(xhr.responseText);
		    if(!data.success) {
		    	$pptItem.remove();
		    	pptMaxNum();
		    	alert(data.msg);
		    }
		    else {
		    	var ppt = {id:'',content:data.data.list};
		    	$pptProgress.style.width = 0;
		    	$pptSize.innerHTML = fileSizeConverter(file.size);
		    	var div = document.createElement('div');
		    	div.addClass('nav');
		    	div.textContent = file.name;
		    	localPPTArr.push(ppt);
		    	socket.send(JSON.stringify({type:6,ppt:ppt}))
		    	// 若刚刚无PPT 则显示该份PPT
		    	if(localPPTArr.length === 1){
		    		resetCanvas();
		    		renderPPT(ppt.content,0);
		    		socket.send(JSON.stringify({type:5,pptIndex:0}));
		    		$pptTip.removeClass('active');
		    		div.addClass('active');
		    	}
		    	$navContainer.appendChild(div);
		    }
		} else if (xhr.status === 0){
			$pptItem.remove();
			pptMaxNum();
			alert('口亨！王奥又访问超时了！');
		}
	}
	xhr.send(fm);
}

function deletePPT(e){
	var t = e.target;
	if(!t.hasClass('ppt-modal-delete')) return;
	var $pptItem = t.parentElement;
	var index = $pptItem.index();
	var $allNav = document.querySelectorAll('.nav');
	var $activeNav = document.querySelector('.nav.active');
	var activeIndex = $activeNav.index();
	$allNav[index].remove();
	document.querySelectorAll('.ppt-modal-item')[index].remove();
	localPPTArr.splice(index,1);
	socket.send(JSON.stringify({type:7,pptIndex:index}));
	pptMaxNum();
	if(activeIndex===index){
		// 删除完无PPT的情况
		if(localPPTArr.length===0){
			$pptTip.addClass('active');
			renderPPT('',-1);
			socket.send(JSON.stringify({type:5,pptIndex:-1}));
		}
		// 删除的是第一份PPT的情况 渲染后一份PPT(即第一份)
		else if(activeIndex===0) {
			document.querySelector('.nav').addClass('active');
			renderPPT(localPPTArr[0].content);
			socket.send(JSON.stringify({type:5,pptIndex:0}));
		}
		// 否则渲染前一份PPT
		else {
			document.querySelectorAll('.nav')[activeIndex-1].addClass('active');
			renderPPT(localPPTArr[index-1].content);
			socket.send(JSON.stringify({type:5,pptIndex:index-1}));
		}
		resetCanvas();
	}
}

function pptMaxNum(){
	var $pptItems = $pptContainer.querySelectorAll('.ppt-modal-item');
	if($pptItems.length >= 3) $pptBtn.addClass('disabled');
	else $pptBtn.removeClass('disabled');
}

function pptUploadBtn(e){
	var t = e.target;
	if(t.hasClass('disabled')) return;
	$pptInput.click();
}