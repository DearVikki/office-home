<!DOCTYPE html>
<html>
<head>
	<title>canvas</title>
</head>
<style>
	canvas{
		border: 1px solid #aaa;
		position: relative;
		/*cursor: url(pen.png), auto;*/
	}
	canvas.eraser{
		/*cursor: url(eraser.png), auto;*/
	}
	button.active{
		opacity: .5;
	}
</style>
<body>
	<p>So here is my canvas:</p>
	<button id="eraser">橡皮擦</button>
	<button id="clear">清屏</button>
	<button id="black" class="color active">黑</button>
	<button id="pink" class="color">粉</button>
	<button id="line1" class="line active">细</button>
	<button id="line5" class="line">粗</button>
	<p></p>
	<canvas id="myCanvas" width=470 height=350></canvas>
	<p>Here is the output:</p>
	<canvas id="outCanvas" width=470 height=350></canvas>
</body>
<script>
	var c = document.getElementById('myCanvas');
	var ctx = c.getContext('2d');
	// pathArr示例：
	// [{
	// 	color:'#000',
	// 	width:1,
	// 	dots:[{
	// 		x:1,
	// 		y:1
	// 	}]
	// }]
	var pathArr = [];
	var eraserArr = [];
	// trigger事件
	var canvasDraw = new Event('canvasDraw');
	var canvasEraser = new Event('canvasEraser');

	function getPos(holder, mouse){
		var rect = holder.getBoundingClientRect();
		return {
			x: mouse.clientX - rect.left,
			y: mouse.clientY - rect.top
		}
	}
	function drawLine(e){
		var pos = getPos(c, e);
		if(!eraser){
			// 画图时
			pathArr[pathArr.length - 1].dots.push({x:pos.x, y:pos.y});
			ctx.lineTo(pos.x, pos.y);
			ctx.stroke();
			c2.dispatchEvent(canvasDraw);
		} else {
			// 擦除时
			eraserArr.push({x:pos.x, y:pos.y});
			ctx.clearRect(pos.x,pos.y,7,7);
			c2.dispatchEvent(canvasEraser);
		}
	}

	// 开始新的一笔
	c.addEventListener('mousedown',function(e){
		var pos = getPos(c, e);
		var msg = 'Mouse position: ' + pos.x + ',' + pos.y;
		// 给pathArr新加入一个数组
		if(!eraser) pathArr.push({color:color,width:width,dots:[]});
		ctx.beginPath();
		ctx.moveTo(pos.x,pos.y);
		c.addEventListener('mousemove',drawLine,false);
	},false)
	c.addEventListener('mouseup',function(){
		c.removeEventListener('mousemove',drawLine,false);
	})

	// 点击橡皮
	var eraser = false;
	var $eraser = document.querySelector('#eraser');
	$eraser.onclick = function(){
		if(!eraser){
			eraser = true;
			$eraser.classList.add('active');
			c.classList.add('eraser');
		} else {
			eraser = false;
			$eraser.classList.remove('active');
			c.classList.remove('eraser');
		}
	}

	var c2 = document.getElementById('outCanvas');
	var ctx2 = c2.getContext('2d');
	c2.addEventListener('canvasDraw',function(){
		var pathArrLine = pathArr[pathArr.length - 1].dots;
		var pathArrLineLen = pathArrLine.length;
		var p = {}, p0 = {};
		p = {x: pathArrLine[pathArrLineLen - 1].x, y: pathArrLine[pathArrLineLen - 1].y};

		if(pathArrLineLen === 1) {
			// ps:之前每次开始新笔划 之前笔划连起来的bug 是由于ctx2.beginPath()放在了最外层只执行了一次！事实是每跳到一个新笔画处都需要重新beginPath的！
			ctx2.beginPath();
			ctx2.strokeStyle =  pathArr[pathArr.length - 1].color;
			ctx2.lineWidth = pathArr[pathArr.length - 1].width;
			ctx2.moveTo(p.x, p.y);
		}
		else{
			p0 = {x: pathArrLine[pathArrLineLen - 2].x, y: pathArrLine[pathArrLineLen - 2].y};
			ctx2.quadraticCurveTo(p0.x, p0.y, p.x, p.y);
		}
		ctx2.stroke();
	},false)
	c2.addEventListener('canvasEraser', function(){
		var eraserArrLen = eraserArr.length;
		ctx2.clearRect(eraserArr[eraserArrLen - 1].x, eraserArr[eraserArrLen - 1].y, 7, 7);
	},false)

	// 点击清屏
	var $clear = document.querySelector('#clear');
	$clear.onclick = function(){
		// 以防万一点击清空时eraser按钮还是active状态
		eraser = false;
		$eraser.classList.remove('active');
		c.classList.remove('eraser');

		ctx.clearRect(0,0, c.width, c.height);
		ctx2.clearRect(0,0, c2.width, c2.height);
	}
	// 点击颜色
	var color = '#000';
	var $black = document.querySelector('#black');
	var $pink = document.querySelector('#pink');
	$black.onclick = function(){
		document.querySelector('.color.active').classList.remove('active');
		$black.classList.add('active');
		ctx.strokeStyle = '#000';
		color = '#000'
	}
	$pink.onclick = function(){
		document.querySelector('.color.active').classList.remove('active');
		$pink.classList.add('active');
		ctx.strokeStyle = '#ffc0cb';
		color = '#ffc0cb';
	}
	// 点击笔触
	// 点击颜色
	var width = 1;
	var $line1 = document.querySelector('#line1');
	var $line5 = document.querySelector('#line5');
	$line1.onclick = function(){
		document.querySelector('.line.active').classList.remove('active');
		$line1.classList.add('active');
		ctx.lineWidth = 1;
		width = 1;
	}
	$line5.onclick = function(){
		document.querySelector('.line.active').classList.remove('active');
		$line5.classList.add('active');
		ctx.lineWidth = 5;
		width = 5;
	}
</script>

</html>